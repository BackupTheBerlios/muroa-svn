#include "cstatemachine.h"

#include <QXmlStreamWriter>
#include <QXmlSimpleReader>

#include <QDebug>

CStateMachine::CStateMachine() : m_xml_src(&m_socket), m_xml_reader(0)
{
    connect(&m_socket, SIGNAL(connected()), this, SLOT(connected()));
    connect(&m_socket, SIGNAL(disconnected()), this, SLOT(disconnected()));
    connect(&m_socket, SIGNAL(readyRead()), this, SLOT(readyRead()));
}

CStateMachine::~CStateMachine()
{

}

void CStateMachine::open(QString host, int port)
{
    m_socket.connectToHost(host, port);
    emit connectionStatusChanged(QString("connection established ...");

}

void CStateMachine::close()
{
    m_xml_writer->writeEndElement();
    m_xml_writer->writeEndDocument();
    if(m_xml_reader)
    {
        delete m_xml_reader;
        m_xml_reader = 0;
    }
    m_socket.disconnectFromHost();

    emit connectionStatusChanged(QString("connection closed.");


}


//void CStateMachine::write8(u_int32_t offset, u_int8_t value)
//{
//    qDebug() << QString("write8");
//    m_xml_writer->writeStartElement("write8");
//    m_xml_writer->writeAttribute("offset", QString().number(offset));
//    m_xml_writer->writeAttribute("value", QString().number(value));
//    m_xml_writer->writeEndElement();
//
//}
//
//u_int32_t CStateMachine::read8(u_int32_t offset)
//{
//    u_int32_t id;
//
//
//    return id;
//}


void CStateMachine::connected()
{
    qDebug() << QString("CStateMachine::connected");
    m_xml_reader = new QXmlSimpleReader();
    m_xml_reader->setContentHandler(&m_contentHandler);
    m_xml_writer = new QXmlStreamWriter(&m_socket);
    m_xml_writer->setAutoFormatting(true);
    m_xml_writer->writeStartDocument(QString("1.0"), true);
    m_xml_writer->writeStartElement("hwtest");
}

void CStateMachine::disconnected()
{
    qDebug() << QString("CStateMachine::disconnected");
    if(m_xml_reader)
    {
        delete m_xml_reader;
        m_xml_reader = 0;
    }
    if(m_xml_writer)
    {
        delete m_xml_writer;
        m_xml_writer = 0;
    }
}

void CStateMachine::error()
{

}

void CStateMachine::readyRead()
{
    m_xml_reader->parse(&m_xml_src, true);
}

void CStateMachine::test()
{
    write8( 100, 200);
}


